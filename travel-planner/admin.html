<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Panel</title>
  <link rel="stylesheet" href="style.css">
</head>
<body style="padding:20px">
  <div class="container">
    <h2>Admin Panel</h2>
    <p class="muted">Only allowed emails can access.</p>
    <div id="admin-ui" style="display:none">
      <button class="primary-btn" id="seed" style="margin-bottom: 16px;">Seed Sample Spots</button>
      <div id="spots">Loading spots...</div>
    </div>
    <p style="margin-top:20px;"><a class="ghost-btn" href="index.html">Back to Home</a></p>
  </div>

  <script type="module">
    import {
      auth, db,
      collection, doc, getDocs, deleteDoc,
      query, orderBy, serverTimestamp, writeBatch, FieldValue,
      onAuthStateChanged
    } from "./firebase.js";

    // IMPORTANT: Put your admin email(s) here
    const ALLOWED_ADMIN_EMAILS = ["you@example.com", "admin@example.com"]; // Replace with actual admin emails

    onAuthStateChanged(auth, async u=>{
      if(!u){
        alert('Login required.');
        location.href='login.html'; // Redirect to general login
        return;
      }
      if(!ALLOWED_ADMIN_EMAILS.includes(u.email)){
        alert('Not authorized as admin.');
        location.href='index.html';
        return;
      }
      document.getElementById('admin-ui').style.display='block';
      await loadSpots();
    });

    async function loadSpots(){
      const cont = document.getElementById('spots');
      cont.innerHTML = 'Loadingâ€¦';
      try {
        const q = query(collection(db,'spots'), orderBy('createdAt','desc'));
        const snap = await getDocs(q);
        if (snap.empty){
          cont.innerHTML = '<p class="muted">No spots yet.</p>';
          return;
        }
        const list = document.createElement('div');
        snap.forEach(d=>{
          const s = d.data();
          const div = document.createElement('div');
          div.className='admin-list-item'; // Use a specific class for admin list items
          div.innerHTML = `
            <div>
              <strong>${s.name||'(no name)'}</strong>
              <div class="muted" style="font-size:12px">${s.location||s.city||''}</div>
              <div class="muted" style="font-size:10px">Created by: ${s.creatorEmail || s.createdBy || 'N/A'}</div>
            </div>
            <div>
              <button class="ghost-btn danger" data-id="${d.id}" onclick="delSpot('${d.id}')">Delete</button>
            </div>`;
          list.appendChild(div);
        });
        cont.innerHTML='';
        cont.appendChild(list);
      } catch (e) {
        console.error("Error loading spots:", e);
        cont.innerHTML = `<p class="muted">Error loading spots: ${e.message}</p>`;
      }
    }

    // Make delSpot globally accessible for onclick
    window.delSpot = async function(id){
      if(!confirm('Are you sure you want to delete this spot? This action cannot be undone.')) return;
      try {
        await deleteDoc(doc(db, 'spots', id));
        alert('Spot deleted successfully!');
        await loadSpots(); // Reload the list
      } catch (e) {
        console.error("Error deleting spot:", e);
        alert('Error deleting spot: ' + e.message);
      }
    };

    document.getElementById('seed').addEventListener('click', async ()=>{
      const currentUser = auth.currentUser;
      if (!currentUser) {
        alert('Please login as an admin first.');
        return;
      }

      const batch = writeBatch(db);
      const col = collection(db, 'spots');
      const seedData = [
        {name:'Goa Beach Escape', location:'Goa', imageURL:'https://picsum.photos/seed/goa/800/500', cost:15000, people:2, points:'Sunset, Seafood, Shacks', startDate:'2024-10-01', endDate:'2024-10-04', transport:'Flight'},
        {name:'Manali Hills', location:'Manali', imageURL:'https://picsum.photos/seed/manali/800/500', cost:12000, people:4, points:'Snow, Trek, Cafe', startDate:'2024-12-10', endDate:'2024-12-14', transport:'Bus'},
        {name:'Jaipur Heritage', location:'Jaipur', imageURL:'https://picsum.photos/seed/jaipur/800/500', cost:9000, people:3, points:'Forts, Food, Markets', startDate:'2024-11-05', endDate:'2024-11-07', transport:'Train'},
        {name:'Kerala Backwaters', location:'Alleppey', imageURL:'https://picsum.photos/seed/kerala/800/500', cost:18000, people:2, points:'Houseboats, Serenity, Nature', startDate:'2025-01-20', endDate:'2025-01-25', transport:'Flight'},
        {name:'Darjeeling Tea Gardens', location:'Darjeeling', imageURL:'https://picsum.photos/seed/darjeeling/800/500', cost:10000, people:3, points:'Tea Estates, Toy Train, Kanchenjunga', startDate:'2025-03-15', endDate:'2025-03-19', transport:'Train'}
      ];

      seedData.forEach(s=>{
        const newDocRef = doc(col); // Create a new document reference with an auto-generated ID
        batch.set(newDocRef, {
          ...s,
          createdAt: serverTimestamp(),
          createdBy: currentUser.uid,
          creatorEmail: currentUser.email
        });
      });

      try {
        await batch.commit();
        alert(`Seeded ${seedData.length} sample spots.`);
        await loadSpots(); // Reload the list
      } catch (e) {
        console.error("Error seeding spots:", e);
        alert('Error seeding spots: ' + e.message);
      }
    });
  </script>
</body>
</html>
